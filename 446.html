<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"> <meta name="author" content="mengkun"> <meta http-equiv="Cache-Control" content="no-transform"> <meta http-equiv="Cache-Control" content="no-siteapp"> <title>Linux环境下实现Nginx日志切割 | 紫苏博客</title> <meta property="article:published_time" content="2019-04-09T05:56:19+08:00"/> <meta property="article:author" content="紫苏博客" /> <meta property="article:published_first" content="紫苏博客,https://www.zsblog.cn/446.html" /> <meta property="og:type" content="article"/> <meta property="og:image" content="https://www.zsblog.cn/wp-content/themes/mkBlog/inc/timthumb.php?src=https://zsblog.cn/wp-content/uploads/2019/04/1554760596-6278-484d4818d25c91fbb05b71678-hd.png&w=270&h=180&zc=1" /> <meta property="og:release_date" content="2019-04-09T05:56:19+08:00"/> <meta property="og:title" content="Linux环境下实现Nginx日志切割 | 紫苏博客" /> <meta property="og:description" content="一. 前提背景及需求 Nginx运行日志默认保存在Nginx安装目录下的 /usr/local/Nginx/logs 文件夹, 包含access.log和error.log两个文件. (1) access.log 记录了哪些用户、哪些页面以及用户浏览器、ip和其他的访问信息； (2) error.log 则是记录服务..." /> <meta name="description" content="一. 前提背景及需求 Nginx运行日志默认保存在Nginx安装目录下的 /usr/local/Nginx/logs 文件夹, 包含access.log和error.log两个文件. (1) access.log 记录了哪些用户、哪些页面以及用户浏览器、ip和其他的访问信息； (2) error.log 则是记录服务..." /> <meta name="keywords" content="Nginx,Linux" /> <link rel="profile" href="http://gmpg.org/xfn/11"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="紫苏博客 RSS Feed" href="/feed/" /> <link rel="alternate" type="application/atom+xml" title="紫苏博客 Atom Feed" href="/feed/atom/" /> <!--[if lt IE 9]> <script src="https://www.zsblog.cn/wp-content/themes/mkBlog/js/html5-css3.js"></script> <![endif]--> <link rel='stylesheet' id='font-awesome-css' href='/wp-content/themes/mkBlog/fonts/font-awesome.min.css?ver=1.93' type='text/css' media='all' /> <link rel='stylesheet' id='fancybox-css' href='/wp-content/themes/mkBlog/css/jquery.fancybox.min.css?ver=1.93' type='text/css' media='all' /> <link rel='stylesheet' id='main-style-css' href='/wp-content/themes/mkBlog/style.css?ver=1.93' type='text/css' media='all' /> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/jquery.min.js?ver=1.93'></script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/jquery.fancybox.min.js?ver=1.93'></script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/prettify.js?ver=1.93'></script> <script type='text/javascript'> /* <![CDATA[ */ var mk_theme_api = {"ajax_url":"https:\/\/www.zsblog.cn\/wp-admin\/admin-ajax.php","home_url":"https:\/\/www.zsblog.cn","theme_url":"https:\/\/www.zsblog.cn\/wp-content\/themes\/mkBlog","qrcode_api":"https:\/\/www.kuaizhan.com\/common\/encode-png?large=true&data="}; /* ]]> */ </script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/script.min.js?ver=1.93'></script> <link rel="canonical" href="/446.html" /> <link rel="icon" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-32x32.png" sizes="32x32" /> <link rel="icon" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-192x192.png" sizes="192x192" /> <link rel="apple-touch-icon-precomposed" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-180x180.png" /> <meta name="msapplication-TileImage" content="https://www.zsblog.cn/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-270x270.png" /> <meta name="baidu-site-verification" content="oPesQ3YHaF" /> <!-- 强制https --> <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137734612-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-137734612-1'); </script></head> <body class="post-template-default single single-post postid-446 single-format-standard"> <!-- 顶部导航栏 --> <nav id="top-navi"> <div id="menu-btn"> <div class="menu-btn-bar"></div> <div class="menu-btn-bar"></div> <div class="menu-btn-bar"></div> </div> <div class="top-navi-content"> <a class="top-navi-logo" href="/"> <img src="https://zsblog.cn/wp-content/uploads/2019/03/20190325_010514_10.png" alt="紫苏博客"> </a> <a class="top-navi-search-btn" href="/search/" title="搜索博客内容"> <i class="fa fa-search" aria-hidden="true"></i> </a> <div class="main-menu"> <ul id="menu-menu" class="menu"><li id="menu-item-8" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8"><a href="https://zsblog.cn/">首页</a></li> <li id="menu-item-12" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-12"><a href="/mood/">吐槽</a></li> <li id="menu-item-15" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-15"><a href="/archives/">归档</a> <ul class="sub-menu"> <li id="menu-item-31" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-31"><a href="/wordpress/">Wordpress</a></li> <li id="menu-item-33" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-33"><a href="/php/">PHP</a></li> <li id="menu-item-32" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-32"><a href="/linux/">Linux</a></li> <li id="menu-item-34" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34"><a href="/uncategorized/">随笔</a></li> </ul> </li> <li id="menu-item-18" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18"><a href="/links/">友链</a></li> <li id="menu-item-30" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-30"><a href="/about/">关于</a> <ul class="sub-menu"> <li id="menu-item-157" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-157"><a href="/album/">相册长廊</a></li> <li id="menu-item-380" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-380"><a href="/copyright-html/">免责声明</a></li> <li id="menu-item-198" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-198"><a href="/tags/">标签大全</a></li> </ul> </li> </ul> </div> </div> </nav><!-- #top-header --> <article id="post-446" class="post-446 post type-post status-publish format-standard hentry category-linux tag-nginx" itemscope itemtype="http://schema.org/Article"> <header class="entry-header"> <h1 class="entry-title">Linux环境下实现Nginx日志切割</h1> <div class="header-info"> <span class="article-auth"> <!-- 文章类型 --> <!-- 文章作者 --> <a href="/446.html" rel="nofollow" target="_blank"> <i class="fa fa-user" aria-hidden="true"></i> zisu </a> </span> <!-- 日期、阅读量、评论、编辑 --> <span class="article-date"> <i class="fa fa-clock-o" aria-hidden="true"></i> <time datetime="2019-04-09 05:04:19" itemprop="datePublished">2019-04-09</time> </span> <span class="article-views"> <i class="fa fa-eye" aria-hidden="true"></i> 798 </span> <span class="article-edit" data-no-instant></span> </div> </header><!-- .entry-header --> <!-- 文章摘要 --> <!-- 正文 --> <div class="entry-content" itemprop="articleBody"> <div class="single-content"> <!-- 文章内容 --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- 文章页head --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5448507556906408" data-ad-slot="3661276472" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><p><strong>一. 前提背景及需求</strong></p> <p><strong><a href="/tag/nginx/" title="Nginx">Nginx</a></strong>运行日志默认保存在<a href="/tag/nginx/" title="Nginx">Nginx</a>安装目录下的 <em><strong>/usr/local/<a href="/tag/nginx/" title="Nginx">Nginx</a>/logs </strong></em>文件夹, 包含<em><strong>access.log</strong></em>和<em><strong>error.log</strong></em>两个文件.</p> <blockquote class="wp-block-quote"><p>(1) <em><strong>access.log</strong></em> 记录了哪些用户、哪些页面以及用户浏览器、ip和其他的访问信息；<br /> (2) <em><strong>error.log </strong></em>则是记录服务器错误日志.</p></blockquote> <p>在所有时间内<a href="/tag/nginx/" title="Nginx">Nginx</a>产生的日志均<strong>保存在同一个文件下</strong>, 随着访问量的增加,尤其是<strong><em>access.log</em></strong>增长极快,服务器会很快消耗磁盘空间，影响服务器效率。<br /> 另外，当需要对日志文件里面记录的数据进行分析时,每次都要耗时很久才能下载这个庞大的日志文件,浪费不必要的时间。</p> <p>因此急需一个处理方案能够<strong>自动化的实现</strong>按天或者按文件大小来<strong>切割<a href="/tag/nginx/" title="Nginx">Nginx</a>日志记录.</strong></p> <p><strong>二. 解决方案: </strong><strong>使用logrotate工具实现日志切割</strong></p> <p><strong>1. logrotate工具的介绍</strong></p> <blockquote class="wp-block-quote"><p><strong>logrotate</strong>是一个<strong>linux系统日志的管理工具</strong>。可以对单个日志文件或者某个目录下的文件<strong>按时间/大小进行切割</strong>，压缩操作；指定日志保存数量；还可以在切割之后运行自定义命令。</p> <p><strong>logrotate</strong>是基于<strong>crontab</strong>运行的，所以这个时间点是由<strong>crontab</strong>控制的，具体可以查询crontab的配置文件/etc/anacrontab。<strong>系统会按照计划的频率运行logrotate，通常是每天</strong>。在大多数的Linux发行版本上，计划每天运行的脚本位于 <strong>/etc/cron.daily/logrotate</strong>。</p> <p>主流Linux发行版上都<strong>默认安装有logrotate包</strong>，如果你的linux系统中找不到logrotate, 可以使用apt-get或yum命令来安装。</p></blockquote> <p>接下来,我们查看logrotate的配置文件</p> <pre class="prettyprint lang- linenums:1">使用指令：rpm -ql logrotate</pre> <p>由下图可知,<strong>logrotate的配置文件</strong>是 <em><strong>/etc/logrotate.conf, </strong></em>这个文件用来定义全局默认参数。</p> <figure class="wp-block-image">::__IHACKLOG_REMOTE_IM<a href="/tag/age/" title="age">age</a>_AUTODOWN_BLOCK__::0</figure> <p>其中, <em><strong>/etc/logrotate.d/ </strong></em>是用于<strong>存储各种自定义应用的配置文件的目录</strong>。该目录里的所有文件都会被<strong>主动的读入</strong>到 <strong>/etc/logrotate.conf</strong>中执行。该目录下的应用配置文件<strong>继承</strong>所有<strong>/etc/logrotate.conf 的</strong>默认参数。<br /> 因此我们可以新建一个针对<a href="/tag/nginx/" title="Nginx">Nginx</a>日志文件的轮循配置的文件，然后将这个文件放在<em><strong>/etc/logrotate.d/ </strong>目录</em>下, 它就会主动的读入到/etc/logrotate.conf中执行, 以达到按指定频率定时执行的需求。</p> <p><strong>2. 创建<a href="/tag/nginx/" title="Nginx">Nginx</a>日志分割文件 </strong>(路径: <em><strong>/etc/logrotate.d/<a href="/tag/nginx/" title="Nginx">Nginx</a> </strong></em>)</p> <pre class="prettyprint lang- linenums:1">新建nginx文件, 存放在/etc/logrotate.d/ 文件夹下, 内容如下

/usr/local/nginx/logs/access.log  {
daily
rotate 7
missingok
dateext
compress
delaycompress
notifempty
sharedscripts
postrotate
    [ -e /usr/local/nginx/logs/nginx.pid ] &amp;&amp; kill -USR1 `cat /usr/local/nginx/logs/nginx.pid`
endscript
}</pre> <ul> <li>home/wwwlogs/*<a href="/tag/nginx/" title="Nginx">Nginx</a>.log 需要轮询日志路径</li> <li>daily: 日志文件分割频度。可选值为 daily，monthly，weekly，yearly</li> <li>rotate 7: 一次将存储7个归档日志。对于第8个归档，时间最久的归档将被删除。</li> <li>missingok: 在日志轮循期间，任何错误将被忽略，例如“文件无法找到”之类的错误。</li> <li>dateext 使用日期作为命名格式</li> <li>compress: 在轮循任务完成后，已轮循的归档将使用gzip进行压缩。</li> <li>nocompress: 如果你不希望对日志文件进行压缩，设置这个参数即可</li> <li>delaycompress: 总是与compress选项一起用，delaycompress选项指示logrotate不要将最近的归档压缩，压缩将在下一次轮循周期进行。这在你或任何软件仍然需要读取最新归档时很有用。</li> <li>notifempty: 如果日志文件为空，轮循不会进行。</li> <li>sharedscripts 表示postrotate脚本在压缩了日志之后只执行一次</li> <li>create 644 www root: 以指定的权限创建全新的日志文件，同时logrotate也会重命名原始日志文件。</li> <li>postrotate/endscript: 最通常的作用是让应用重启，以便切换到新的日志文件, 在所有其它指令完成后，postrotate和endscript里面指定的命令将被执行。在这种情况下，rsyslogd 进程将立即再次读取其配置并继续运行。</li> </ul> <p><strong>3. 运行logrotate</strong></p> <pre class="prettyprint lang- linenums:1">使用指令: logrotate/etc/logrotate.d/nginx</pre> <p><strong>测试日志切割</strong> (如果文件的时间小于一天，不会执行切割日志 )</p> <pre class="prettyprint lang- linenums:1">使用指令: logrotate -d /etc/logrotate.d/nginx</pre> <p><strong>强制轮询切割日志 ( </strong>为了便于我们直观的观察测试结果,建议大家手动试一下 )</p> <pre class="prettyprint lang- linenums:1">使用指令:  logrotate -vf /etc/logrotate.d/nginx</pre> <p>至此, 我们使用<strong>logrotate</strong>配置的<a href="/tag/nginx/" title="Nginx">Nginx</a>日志切割功能已经实现了, 它会按照设定的频率定时的执行下去,最后附加一张示例图—-<a href="/tag/nginx/" title="Nginx">Nginx</a>切割后的日志目录:</p> <figure class="wp-block-image">::__IHACKLOG_REMOTE_IM<a href="/tag/age/" title="age">age</a>_AUTODOWN_BLOCK__::1</figure> <p><strong>附: 报错处理<br /> </strong></p> <figure class="wp-block-image"><a href="https://zsblog.cn/wp-content/uploads/2019/04/1554760596-6278-484d4818d25c91fbb05b71678-hd.png"><img class="attachment-full size-full" src="https://zsblog.cn/wp-content/uploads/2019/04/1554760596-6278-484d4818d25c91fbb05b71678-hd.png" alt="Linux环境下实现Nginx日志切割" sizes="(max-width: 720px) 100vw, 720px" srcset="https://zsblog.cn/wp-content/uploads/2019/04/1554760596-6278-484d4818d25c91fbb05b71678-hd.png 720w, https://zsblog.cn/wp-content/uploads/2019/04/1554760596-6278-484d4818d25c91fbb05b71678-hd-300x80.png 300w"></a></figure> <p><strong>原因: </strong>需要将我们的/etc/logrotate.d/<a href="/tag/nginx/" title="Nginx">Nginx</a> 将dos格式文本转化为unix格式</p> <p><strong>解决方案: </strong>参考 <a href="/go/?url=http://link.zhihu.com/?target=http%3A//superuser.com/questions/52044/convert-crlfs-to-line-feeds-on-linux" rel="nofollow" data-no-instant target="_blank">Convert CRLF’s to line feeds on Linux</a></p> <p><strong>1. 第一步, </strong>安装<strong>dos2unix</strong>, 指令为: <strong><em>yum install dos2unix</em></strong></p> <figure class="wp-block-image"><a href="https://zsblog.cn/wp-content/uploads/2019/04/1554760597-4571-c21ed0ee0863e53a02b9afa11-hd.png"><img class="attachment-full size-full" src="https://zsblog.cn/wp-content/uploads/2019/04/1554760597-4571-c21ed0ee0863e53a02b9afa11-hd.png" alt="Linux环境下实现Nginx日志切割" sizes="(max-width: 581px) 100vw, 581px" srcset="https://zsblog.cn/wp-content/uploads/2019/04/1554760597-4571-c21ed0ee0863e53a02b9afa11-hd.png 581w, https://zsblog.cn/wp-content/uploads/2019/04/1554760597-4571-c21ed0ee0863e53a02b9afa11-hd-300x92.png 300w"></a></figure> <p><strong>2. 第二步, </strong>执行转换, 指令为: <strong><em>dos2unix /etc/logrotate.d/<a href="/tag/nginx/" title="Nginx">Nginx</a></em></strong></p> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- 文章页下方 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5448507556906408" data-ad-slot="9680245136" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> </div> <div class="content-extras clear-fix"> <!-- 版权信息 --> <p class="single-copyright"> 本文作者为<a href="/446.html" rel="nofollow" target="_blank">zisu</a>，转载请注明。 </p> <!-- 文章标签 --> <p class="single-tags"> <i class="fa fa-tag" aria-hidden="true"></i><a href="/tag/nginx/" rel="tag">Nginx</a> </p> </div> <!-- content-extras --> </div><!-- .entry-content --> <!-- 点赞、分享、打赏组件 --> <div class="social-main"> <div class="like favorite" data-action="ding" data-id="446"> <span class="likeHeart" rel="like"></span> <span class="count">0</span>人点赞 </div> </div> </article><!-- #post --> <div id="article-share"> 分享 <div class="share-item" data-site="weixin" title="分享到微信"> <i class="fa fa-weixin"></i> 微信 </div> <div class="share-item" data-site="weibo" title="分享到新浪微博"> <i class="fa fa-weibo"></i> 微博 </div> <div class="share-item" data-site="qq" title="分享给QQ好友"> <i class="fa fa-qq"></i> QQ </div> </div> <div id="article-menu" data-automenu></div> <footer id="site-footer"> Copyright © zisu & <a href="/" >紫苏博客</a> All Rights Rsesrved. <span>苏ICP备15050462号-1 </span> </footer> <!--[if IE]> <div class="no-ie"> <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> 本博客已不支持 IE <a href="http://lab.mkblog.cn/music/plugns/killie/" target="_blank">点击升级浏览器</a> </div> <![endif]--> <!-- 返回顶部按钮 --> <div id="scroll-to-top" title="返回顶部" class="headroom"> <i class="fa fa-chevron-up" aria-hidden="true"></i> </div> <!-- 初始化小表情、灯箱、代码高亮 --> <script>initTheme();</script> <script data-no-instant> InstantClick.on('change', function(isInitialLoad) { if(isInitialLoad === false) { if(typeof ga!=='undefined') ga('send', 'pageview', location.pathname + location.search); if(typeof MathJax!=='undefined') { MathJax.Hub.Queue(["Typeset",MathJax.Hub]) } if (typeof _hmt !== 'undefined'){ _hmt.push(['_trackPageview', location.pathname + location.search]); } console.log('InitialLoad'); } else { console.log('Normal'); } }); InstantClick.init('mousedown'); </script> </body> </html>
<!--
Performance optimized by W3 Total Cache. Learn more: https://www.w3-edge.com/products/

Object Caching 57/80 objects using memcached
Page Caching using memcached 
Database Caching using memcached

Served from: zsblog.cn @ 2019-04-29 21:37:35 by W3 Total Cache
-->