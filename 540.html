<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"> <meta name="author" content="mengkun"> <meta http-equiv="Cache-Control" content="no-transform"> <meta http-equiv="Cache-Control" content="no-siteapp"> <title>PHP-FPM 与 Nginx 的通信机制总结 | 紫苏博客</title> <meta property="article:published_time" content="2019-04-20T13:04:32+08:00"/> <meta property="article:author" content="紫苏博客" /> <meta property="article:published_first" content="紫苏博客,https://www.zsblog.cn/540.html" /> <meta property="og:type" content="article"/> <meta property="og:image" content="https://www.zsblog.cn/wp-content/themes/mkBlog/inc/timthumb.php?src=https://www.zsblog.cn/wp-content/uploads/2019/04/1555736685-5704-.png&w=270&h=180&zc=1" /> <meta property="og:release_date" content="2019-04-20T13:04:32+08:00"/> <meta property="og:title" content="PHP-FPM 与 Nginx 的通信机制总结 | 紫苏博客" /> <meta property="og:description" content="php-FPM 介绍 CGI 协议与 FastCGI 协议 每种动态语言（ php,Python 等）的代码文件需要通过对应的解析器才能被服务器识别，而 CGI 协议就是用来使解释器与服务器可以互相通信。php 文件在服务器上的解析需要用到 php 解释器，再加上对应的 CGI ..." /> <meta name="description" content="php-FPM 介绍 CGI 协议与 FastCGI 协议 每种动态语言（ php,Python 等）的代码文件需要通过对应的解析器才能被服务器识别，而 CGI 协议就是用来使解释器与服务器可以互相通信。php 文件在服务器上的解析需要用到 php 解释器，再加上对应的 CGI ..." /> <meta name="keywords" content="Nginx,PHP-FPM,Linux" /> <link rel="profile" href="http://gmpg.org/xfn/11"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="紫苏博客 RSS Feed" href="/feed/" /> <link rel="alternate" type="application/atom+xml" title="紫苏博客 Atom Feed" href="/feed/atom/" /> <!--[if lt IE 9]> <script src="https://www.zsblog.cn/wp-content/themes/mkBlog/js/html5-css3.js"></script> <![endif]--> <link rel='stylesheet' id='font-awesome-css' href='/wp-content/themes/mkBlog/fonts/font-awesome.min.css?ver=1.93' type='text/css' media='all' /> <link rel='stylesheet' id='fancybox-css' href='/wp-content/themes/mkBlog/css/jquery.fancybox.min.css?ver=1.93' type='text/css' media='all' /> <link rel='stylesheet' id='main-style-css' href='/wp-content/themes/mkBlog/style.css?ver=1.93' type='text/css' media='all' /> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/jquery.min.js?ver=1.93'></script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/jquery.fancybox.min.js?ver=1.93'></script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/prettify.js?ver=1.93'></script> <script type='text/javascript'> /* <![CDATA[ */ var mk_theme_api = {"ajax_url":"https:\/\/www.zsblog.cn\/wp-admin\/admin-ajax.php","home_url":"https:\/\/www.zsblog.cn","theme_url":"https:\/\/www.zsblog.cn\/wp-content\/themes\/mkBlog","qrcode_api":"https:\/\/www.kuaizhan.com\/common\/encode-png?large=true&data="}; /* ]]> */ </script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/script.min.js?ver=1.93'></script> <link rel="canonical" href="/540.html" /> <link rel="icon" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-32x32.png" sizes="32x32" /> <link rel="icon" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-192x192.png" sizes="192x192" /> <link rel="apple-touch-icon-precomposed" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-180x180.png" /> <meta name="msapplication-TileImage" content="https://www.zsblog.cn/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-270x270.png" /> <meta name="baidu-site-verification" content="oPesQ3YHaF" /> <!-- 强制https --> <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137734612-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-137734612-1'); </script></head> <body class="post-template-default single single-post postid-540 single-format-standard"> <!-- 顶部导航栏 --> <nav id="top-navi"> <div id="menu-btn"> <div class="menu-btn-bar"></div> <div class="menu-btn-bar"></div> <div class="menu-btn-bar"></div> </div> <div class="top-navi-content"> <a class="top-navi-logo" href="/"> <img src="https://zsblog.cn/wp-content/uploads/2019/03/20190325_010514_10.png" alt="紫苏博客"> </a> <a class="top-navi-search-btn" href="/search/" title="搜索博客内容"> <i class="fa fa-search" aria-hidden="true"></i> </a> <div class="main-menu"> <ul id="menu-menu" class="menu"><li id="menu-item-8" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8"><a href="https://zsblog.cn/">首页</a></li> <li id="menu-item-12" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-12"><a href="/mood/">吐槽</a></li> <li id="menu-item-15" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-15"><a href="/archives/">归档</a> <ul class="sub-menu"> <li id="menu-item-31" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-31"><a href="/wordpress/">Wordpress</a></li> <li id="menu-item-33" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-33"><a href="/php/">PHP</a></li> <li id="menu-item-32" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-32"><a href="/linux/">Linux</a></li> <li id="menu-item-34" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34"><a href="/uncategorized/">随笔</a></li> </ul> </li> <li id="menu-item-18" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18"><a href="/links/">友链</a></li> <li id="menu-item-30" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-30"><a href="/about/">关于</a> <ul class="sub-menu"> <li id="menu-item-157" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-157"><a href="/album/">相册长廊</a></li> <li id="menu-item-380" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-380"><a href="/copyright-html/">免责声明</a></li> <li id="menu-item-198" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-198"><a href="/tags/">标签大全</a></li> </ul> </li> </ul> </div> </div> </nav><!-- #top-header --> <article id="post-540" class="post-540 post type-post status-publish format-standard hentry category-linux tag-nginx tag-php-fpm" itemscope itemtype="http://schema.org/Article"> <header class="entry-header"> <h1 class="entry-title">PHP-FPM 与 Nginx 的通信机制总结</h1> <div class="header-info"> <span class="article-auth"> <!-- 文章类型 --> <!-- 文章作者 --> <a href="/540.html" rel="nofollow" target="_blank"> <i class="fa fa-user" aria-hidden="true"></i> zisu </a> </span> <!-- 日期、阅读量、评论、编辑 --> <span class="article-date"> <i class="fa fa-clock-o" aria-hidden="true"></i> <time datetime="2019-04-20 01:04:32" itemprop="datePublished">2019-04-20</time> </span> <span class="article-views"> <i class="fa fa-eye" aria-hidden="true"></i> 49 </span> <span class="article-edit" data-no-instant></span> </div> </header><!-- .entry-header --> <!-- 文章摘要 --> <!-- 正文 --> <div class="entry-content" itemprop="articleBody"> <div class="single-content"> <!-- 文章内容 --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- 文章页head --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5448507556906408" data-ad-slot="3661276472" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><h2><a href="/tag/php/" title="php">php</a>-FPM 介绍</h2> <div data-unique="180419"></div> <h3>CGI 协议与 FastCGI 协议</h3> <p>每种动态语言（ <a href="/tag/php/" title="php">php</a>,Python 等）的代码文件需要通过对应的解析器才能被服务器识别，而 CGI 协议就是用来使解释器与服务器可以互相通信。<a href="/tag/php/" title="php">php</a> 文件在服务器上的解析需要用到 <a href="/tag/php/" title="php">php</a> 解释器，再加上对应的 CGI 协议，从而使服务器可以解析到 <a href="/tag/php/" title="php">php</a> 文件。</p> <p>由于 CGI 的机制是每处理一个请求需要 fork 一个 CGI 进程，请求结束再 kill 掉这个进程，在实际应用上比较浪费资源，于是就出现了 CGI 的改良版本 FastCGI，FastCGI 在请求处理完后，不会 kill 掉进程，而是继续处理多个请求，这样就大大提高了效率。</p> <div data-unique="2891d9"></div> <h3><a href="/tag/php/" title="php">php</a>-FPM 是什么</h3> <p><a href="/tag/php/" title="php">php</a>-FPM 即 <a href="/tag/php/" title="php">php</a>-FastCGI Process Man<a href="/tag/age/" title="age">age</a>r， 它是 FastCGI 的实现，并提供了进程管理的功能。进程包含 master 进程和 worker 进程两种；master 进程只有一个，负责监听端口，接收来自服务器的请求，而 worker 进程则一般有多个（具体数量根据实际需要进行配置），每个进程内部都会嵌入一个 <a href="/tag/php/" title="php">php</a> 解释器，是代码真正执行的地方。</p> <div data-unique="53ffc8"></div> <h2><a href="/tag/nginx/" title="Nginx">Nginx</a> 与 <a href="/tag/php/" title="php">php</a>-fpm 通信机制</h2> <p>当我们访问一个网站（如 www.test.com）的时候，处理流程是这样的：</p> <pre class="prettyprint lang- linenums:1">www.test.com
        |
        |
      Nginx
        |
        |
路由到 www.test.com/index.php
        |
        |
加载 nginx 的 fast-cgi 模块
        |
        |
fast-cgi 监听 127.0.0.1:9000 地址
        |
        |
www.test.com/index.php 请求到达 127.0.0.1:9000
        |
        |
     等待处理...</pre> <p>&nbsp;</p> <h3><a href="/tag/nginx/" title="Nginx">Nginx</a> 与 <a href="/tag/php/" title="php">php</a>-fpm 的结合</h3> <p>在 Linux 上，<a href="/tag/nginx/" title="Nginx">Nginx</a> 与 <a href="/tag/php/" title="php">php</a>-fpm 的通信有 tcp socket 和 unix socket 两种方式。</p> <p>tcp socket 的优点是可以跨服务器，当 <a href="/tag/nginx/" title="Nginx">Nginx</a> 和 <a href="/tag/php/" title="php">php</a>-fpm 不在同一台机器上时，只能使用这种方式。</p> <p>Unix socket 又叫 IPC (inter-process communication 进程间通信) socket，用于实现同一主机上的进程间通信，这种方式需要在 <a href="/tag/nginx/" title="Nginx">Nginx</a> 配置文件中填写 <a href="/tag/php/" title="php">php</a>-fpm 的 socket 文件位置。</p> <p>两种方式的数据传输过程如下图所示：</p> <div class="fluidbox__wrap"> <p><a href="/wp-content/uploads/2019/04/1555736685-5704-.png"><img class="attachment-full size-full" src="/wp-content/uploads/2019/04/1555736685-5704-.png" alt="PHP-FPM 与 Nginx 的通信机制总结" sizes="(max-width: 622px) 100vw, 622px" srcset="/wp-content/uploads/2019/04/1555736685-5704-.png 622w, /wp-content/uploads/2019/04/1555736685-5704--300x228.png 300w"></a></p> <div class="fluidbox__ghost"></div> </div> <p>二者的不同：</p> <p>由于 Unix socket 不需要经过网络协议栈，不需要打包拆包、计算校验和、维护序号和应答等，只是将应用层数据从一个进程拷贝到另一个进程。所以其效率比 tcp socket 的方式要高，可减少不必要的 tcp 开销。不过，unix socket 高并发时不稳定，连接数爆发时，会产生大量的长时缓存，在没有面向连接协议的支撑下，大数据包可能会直接出错不返回异常。而 tcp 这样的面向连接的协议，可以更好的保证通信的正确性和完整性。</p> <p><a href="/tag/nginx/" title="Nginx">Nginx</a> 与 <a href="/tag/php/" title="php">php</a>-fpm 结合只需要在各自的配置文件中做设置即可：</p> <p>1） <a href="/tag/nginx/" title="Nginx">Nginx</a> 中的配置</p> <p>以 tcp socket 通信为例</p> <pre class="prettyprint lang-php linenums:1">server {
    listen       80; #监听 80 端口，接收http请求
    server_name  www.test.com; #就是网站地址
    root /usr/local/etc/nginx/www/huxintong_admin; # 准备存放代码工程的路径
    #路由到网站根目录 www.test.com 时候的处理
    location / {
        index index.php; #跳转到 www.test.com/index.php
        autoindex on;
    }   

    #当请求网站下 php 文件的时候，反向代理到 php-fpm
    location ~ \.php$ {
        include /usr/local/etc/nginx/fastcgi.conf; #加载 nginx 的 fastcgi 模块
        fastcgi_intercept_errors on;
        fastcgi_pass   127.0.0.1:9000; # tcp 方式，php-fpm 监听的 IP 地址和端口
       # fasrcgi_pass /usr/run/php-fpm.sock # unix socket 连接方式
    }

}</pre> <p>2) <a href="/tag/php/" title="php">php</a>-fpm 的配置</p> <pre class="prettyprint lang- linenums:1">listen = 127.0.0.1:9000
# 或者下面这样
listen = /var/run/php-fpm.sock</pre> <blockquote><p>注意，在使用 unix socket 方式连接时，由于 socket 文件本质上是一个文件，存在权限控制的问题，所以需要注意 <a href="/tag/nginx/" title="Nginx">Nginx</a> 进程的权限与 <a href="/tag/php/" title="php">php</a>-fpm 的权限问题，不然会提示无权限访问。（在各自的配置文件里设置用户）</p></blockquote> <p>通过以上配置即可完成 <a href="/tag/php/" title="php">php</a>-fpm 与 <a href="/tag/nginx/" title="Nginx">Nginx</a> 的通信。</p> <div data-unique="c9fff6"></div> <h3>在应用中的选择</h3> <p>如果是在同一台服务器上运行的 <a href="/tag/nginx/" title="Nginx">Nginx</a> 和 <a href="/tag/php/" title="php">php</a>-fpm，且并发量不高（不超过 1000），选择 unix socket，以提高 <a href="/tag/nginx/" title="Nginx">Nginx</a> 和 <a href="/tag/php/" title="php">php</a>-fpm 的通信效率。<br /> 如果是面临高并发业务，则考虑选择使用更可靠的 tcp socket，以负载均衡、内核优化等运维手段维持效率。</p> <p>若并发较高但仍想用 unix socket 时，可通过以下方式提高 unix socket 的稳定性。</p> <p>1）将 sock 文件放在 /dev/shm 目录下，此目录下将 sock 文件放在内存里面，内存的读写更快。</p> <p>2）提高 backlog</p> <p>backlog 默认位 128，1024 这个值换成自己正常的 QPS，配置如下。</p> <p><a href="/tag/nginx/" title="Nginx">Nginx</a>.conf 文件中</p> <pre class="prettyprint lang-php linenums:1">server {
        listen 80 default backlog = 1024;
       }</pre> <p><a href="/tag/php/" title="php">php</a>-fpm.conf 文件中</p> <pre class="prettyprint lang- linenums:1">listen.backlog = 1024</pre> <p>3）增加 sock 文件和 <a href="/tag/php/" title="php">php</a>-fpm 实例</p> <p>在 /dev/shm 新建一个 sock 文件，在 <a href="/tag/nginx/" title="Nginx">Nginx</a> 中通过 upstream 模块将请求负载均衡到两个 sock 文件，并且将两个 sock 文件分别对应到两套 <a href="/tag/php/" title="php">php</a>-fpm 实例上。</p> <p><em>个人总结，若有不对，敬请指正～</em></p> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- 文章页下方 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5448507556906408" data-ad-slot="9680245136" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> </div> <div class="content-extras clear-fix"> <!-- 版权信息 --> <p class="single-copyright"> 本文作者为<a href="/540.html" rel="nofollow" target="_blank">zisu</a>，转载请注明。 </p> <!-- 文章标签 --> <p class="single-tags"> <i class="fa fa-tag" aria-hidden="true"></i><a href="/tag/nginx/" rel="tag">Nginx</a> <i class="fa fa-tag" aria-hidden="true"></i><a href="/tag/php-fpm/" rel="tag">PHP-FPM</a> </p> </div> <!-- content-extras --> </div><!-- .entry-content --> <!-- 点赞、分享、打赏组件 --> <div class="social-main"> <div class="like favorite" data-action="ding" data-id="540"> <span class="likeHeart" rel="like"></span> <span class="count">5</span>人点赞 </div> </div> </article><!-- #post --> <div id="article-share"> 分享 <div class="share-item" data-site="weixin" title="分享到微信"> <i class="fa fa-weixin"></i> 微信 </div> <div class="share-item" data-site="weibo" title="分享到新浪微博"> <i class="fa fa-weibo"></i> 微博 </div> <div class="share-item" data-site="qq" title="分享给QQ好友"> <i class="fa fa-qq"></i> QQ </div> </div> <div id="article-menu" data-automenu></div> <footer id="site-footer"> Copyright © zisu & <a href="/" >紫苏博客</a> All Rights Rsesrved. <span>苏ICP备15050462号-1 </span> </footer> <!--[if IE]> <div class="no-ie"> <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> 本博客已不支持 IE <a href="http://lab.mkblog.cn/music/plugns/killie/" target="_blank">点击升级浏览器</a> </div> <![endif]--> <!-- 返回顶部按钮 --> <div id="scroll-to-top" title="返回顶部" class="headroom"> <i class="fa fa-chevron-up" aria-hidden="true"></i> </div> <!-- 初始化小表情、灯箱、代码高亮 --> <script>initTheme();</script> <script data-no-instant> InstantClick.on('change', function(isInitialLoad) { if(isInitialLoad === false) { if(typeof ga!=='undefined') ga('send', 'pageview', location.pathname + location.search); if(typeof MathJax!=='undefined') { MathJax.Hub.Queue(["Typeset",MathJax.Hub]) } if (typeof _hmt !== 'undefined'){ _hmt.push(['_trackPageview', location.pathname + location.search]); } console.log('InitialLoad'); } else { console.log('Normal'); } }); InstantClick.init('mousedown'); </script> </body> </html>
<!--
Performance optimized by W3 Total Cache. Learn more: https://www.w3-edge.com/products/

Object Caching 59/82 objects using memcached
Page Caching using memcached 
Database Caching using memcached

Served from: zsblog.cn @ 2019-04-29 21:37:47 by W3 Total Cache
-->