<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"> <meta name="author" content="mengkun"> <meta http-equiv="Cache-Control" content="no-transform"> <meta http-equiv="Cache-Control" content="no-siteapp"> <title>Linux VPS安装Google Authenticator实现SSH登陆二次验证 | 紫苏博客</title> <meta property="article:published_time" content="2019-04-09T00:01:03+08:00"/> <meta property="article:author" content="紫苏博客" /> <meta property="article:published_first" content="紫苏博客,https://www.zsblog.cn/406.html" /> <meta property="og:type" content="article"/> <meta property="og:image" content="https://www.zsblog.cn/wp-content/themes/mkBlog/inc/timthumb.php?src=https://zsblog.cn/wp-content/uploads/2019/04/1554739257-1074-Google-Authenticator.png&w=270&h=180&zc=1" /> <meta property="og:release_date" content="2019-04-09T00:01:03+08:00"/> <meta property="og:title" content="Linux VPS安装Google Authenticator实现SSH登陆二次验证 | 紫苏博客" /> <meta property="og:description" content="说明：一般我们考虑到VPS的安全问题的时候，都是更改SSH端口和密码，然后更安全的也就是禁用密码使用密匙登录。方法很久前就水过了，这里再分享一个方法，可以在VPS上安装一个Google Authenticator(谷歌身份验证器)，这样我们登录VPS的时候，不..." /> <meta name="description" content="说明：一般我们考虑到VPS的安全问题的时候，都是更改SSH端口和密码，然后更安全的也就是禁用密码使用密匙登录。方法很久前就水过了，这里再分享一个方法，可以在VPS上安装一个Google Authenticator(谷歌身份验证器)，这样我们登录VPS的时候，不..." /> <meta name="keywords" content="Google Authenticator,Linux" /> <link rel="profile" href="http://gmpg.org/xfn/11"> <!-- RSS --> <link rel="alternate" type="application/rss+xml" title="紫苏博客 RSS Feed" href="/feed/" /> <link rel="alternate" type="application/atom+xml" title="紫苏博客 Atom Feed" href="/feed/atom/" /> <!--[if lt IE 9]> <script src="https://www.zsblog.cn/wp-content/themes/mkBlog/js/html5-css3.js"></script> <![endif]--> <link rel='stylesheet' id='font-awesome-css' href='/wp-content/themes/mkBlog/fonts/font-awesome.min.css?ver=1.93' type='text/css' media='all' /> <link rel='stylesheet' id='fancybox-css' href='/wp-content/themes/mkBlog/css/jquery.fancybox.min.css?ver=1.93' type='text/css' media='all' /> <link rel='stylesheet' id='main-style-css' href='/wp-content/themes/mkBlog/style.css?ver=1.93' type='text/css' media='all' /> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/jquery.min.js?ver=1.93'></script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/jquery.fancybox.min.js?ver=1.93'></script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/prettify.js?ver=1.93'></script> <script type='text/javascript'> /* <![CDATA[ */ var mk_theme_api = {"ajax_url":"https:\/\/www.zsblog.cn\/wp-admin\/admin-ajax.php","home_url":"https:\/\/www.zsblog.cn","theme_url":"https:\/\/www.zsblog.cn\/wp-content\/themes\/mkBlog","qrcode_api":"https:\/\/www.kuaizhan.com\/common\/encode-png?large=true&data="}; /* ]]> */ </script> <script type='text/javascript' src='/wp-content/themes/mkBlog/js/script.min.js?ver=1.93'></script> <link rel="canonical" href="/406.html" /> <link rel="icon" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-32x32.png" sizes="32x32" /> <link rel="icon" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-192x192.png" sizes="192x192" /> <link rel="apple-touch-icon-precomposed" href="/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-180x180.png" /> <meta name="msapplication-TileImage" content="https://www.zsblog.cn/wp-content/uploads/2019/03/cropped-20190325_010521_43-1-270x270.png" /> <meta name="baidu-site-verification" content="oPesQ3YHaF" /> <!-- 强制https --> <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137734612-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-137734612-1'); </script></head> <body class="post-template-default single single-post postid-406 single-format-standard"> <!-- 顶部导航栏 --> <nav id="top-navi"> <div id="menu-btn"> <div class="menu-btn-bar"></div> <div class="menu-btn-bar"></div> <div class="menu-btn-bar"></div> </div> <div class="top-navi-content"> <a class="top-navi-logo" href="/"> <img src="https://zsblog.cn/wp-content/uploads/2019/03/20190325_010514_10.png" alt="紫苏博客"> </a> <a class="top-navi-search-btn" href="/search/" title="搜索博客内容"> <i class="fa fa-search" aria-hidden="true"></i> </a> <div class="main-menu"> <ul id="menu-menu" class="menu"><li id="menu-item-8" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8"><a href="https://zsblog.cn/">首页</a></li> <li id="menu-item-12" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-12"><a href="/mood/">吐槽</a></li> <li id="menu-item-15" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-15"><a href="/archives/">归档</a> <ul class="sub-menu"> <li id="menu-item-31" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-31"><a href="/wordpress/">Wordpress</a></li> <li id="menu-item-33" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-33"><a href="/php/">PHP</a></li> <li id="menu-item-32" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-32"><a href="/linux/">Linux</a></li> <li id="menu-item-34" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34"><a href="/uncategorized/">随笔</a></li> </ul> </li> <li id="menu-item-18" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-18"><a href="/links/">友链</a></li> <li id="menu-item-30" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-30"><a href="/about/">关于</a> <ul class="sub-menu"> <li id="menu-item-157" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-157"><a href="/album/">相册长廊</a></li> <li id="menu-item-380" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-380"><a href="/copyright-html/">免责声明</a></li> <li id="menu-item-198" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-198"><a href="/tags/">标签大全</a></li> </ul> </li> </ul> </div> </div> </nav><!-- #top-header --> <article id="post-406" class="post-406 post type-post status-publish format-standard hentry category-linux tag-google-authenticator" itemscope itemtype="http://schema.org/Article"> <header class="entry-header"> <h1 class="entry-title">Linux VPS安装Google Authenticator实现SSH登陆二次验证</h1> <div class="header-info"> <span class="article-auth"> <!-- 文章类型 --> <!-- 文章作者 --> <a href="/406.html" rel="nofollow" target="_blank"> <i class="fa fa-user" aria-hidden="true"></i> zisu </a> </span> <!-- 日期、阅读量、评论、编辑 --> <span class="article-date"> <i class="fa fa-clock-o" aria-hidden="true"></i> <time datetime="2019-04-09 12:04:03" itemprop="datePublished">2019-04-09</time> </span> <span class="article-views"> <i class="fa fa-eye" aria-hidden="true"></i> 39 </span> <span class="article-edit" data-no-instant></span> </div> </header><!-- .entry-header --> <!-- 文章摘要 --> <!-- 正文 --> <div class="entry-content" itemprop="articleBody"> <div class="single-content"> <!-- 文章内容 --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- 文章页head --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5448507556906408" data-ad-slot="3661276472" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><p><strong>说明：</strong>一般我们考虑到<code>VPS</code>的安全问题的时候，都是更改<code>SSH</code>端口和密码，然后更安全的也就是禁用密码使用密匙登录。方法很久前就水过了，这里再分享一个方法，可以在<code>VPS</code>上安装一个<code><a href="https://www.zsblog.cn/tag/google-authenticator/" title="Google Authenticator">Google Authenticator</a></code>(谷歌身份验证器)，这样我们登录<code>VPS</code>的时候，不仅需要密码正确，而且还要你输入正确的动态验证码才能登录进去，这样安全性就高了不少，这里就说下<code>CentOS</code>、<code>Debian</code>、<code>Ubuntu</code>的使用。</p> <pre class="prettyprint lang- linenums:1">提示：教程需要配合Google身份验证器一起使用，手机没有安装该APP的需要安装一下，方便获取动态验证码。</pre> <h2>安装</h2> <p><strong>1、软件包安装</strong></p> <pre class="prettyprint lang-bsh linenums:1">#CentOS 6系统
rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm
yum install google-authenticator -y

#CentOS 7系统
rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum install google-authenticator -y

#Debian/Ubuntu系统
apt update
apt install libpam-google-authenticator -y</pre> <p><strong>2、编译安装</strong><br /> 安装依赖：</p> <pre class="prettyprint lang-bsh linenums:1">#CentOS系统
yum install gcc make pam-devel libpng-devel libtool wget git autoconf automake qrencode -y

#Debian/Ubuntu系统
apt update
apt install -y gcc make autoconf automake libtool libpam0g-dev libqrencode3 git</pre> <p>安装验证器：</p> <pre class="prettyprint lang-bsh linenums:1">git clone https://github.com/google/google-authenticator-libpam.git
cd google-authenticator-libpam
./bootstrap.sh
./configure
make &amp;&amp; make install</pre> <h2>配置</h2> <p><strong>1、配置验证器</strong></p> <p>输出如下：</p> <pre class="prettyprint lang-bsh linenums:1">Do you want authentication tokens to be time-based (y/n) y
#验证二维码，在浏览器打开使用谷歌验证器APP扫描添加即可。
https://www.google.com/chart?chs=200x200xxx
Your new secret key is: WKDPJHOKR2P3DOWL
Your verification code is 189192
#临时验证码，手机不在身边可以使用，不过一个码只能用一次
Your emergency scratch codes are:
  77678926
  14729443
  83656478
  55669982
  23960253

#下面可以直接照着填，或者自己使用谷歌翻译，然后自行选择
Do you want me to update your "/root/.google_authenticator" file (y/n) y

Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y

By default, tokens are good for 30 seconds and in order to compensate for
possible time-skew between the client and the server, we allow an extra
token before and after the current time. If you experience problems with poor
time synchronization, you can increase the window from its default
size of 1:30min to about 4min. Do you want to do so (y/n) y

If the computer that you are logging into isn't hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting (y/n) y</pre> <p>2、配置PAM文件<br /> 修改<code>PAM</code>配置文件：</p> <pre class="prettyprint lang- linenums:1">nano /etc/pam.d/sshd</pre> <p>在相应的位置添加<code>auth required pam_google_authenticator.so</code>代码，大概如下：</p> <pre class="prettyprint lang-bsh linenums:1">#CentOS 6在#%PAM-1.0下面一行添加
#CentOS 7在auth substack password-auth下面一行添加
#Debian和Ubuntu在末尾添加</pre> <p>然后使用<code>Ctrl+x</code>、<code>y</code>保存退出。</p> <p>或者直接使用命令添加：</p> <pre class="prettyprint lang-bsh linenums:1">#CentOS 6系统
sed -i '1a\auth required pam_google_authenticator.so' /etc/pam.d/sshd
#CentOS 7系统
sed -i "/auth[ ]*substack[ ]*pass*/a\auth required pam_google_authenticator.so" /etc/pam.d/sshd
#Debian/Ubuntu系统
echo 'auth required pam_google_authenticator.so' &gt;&gt;/etc/pam.d/sshd</pre> <p>如果是编译安装的，还需要做一下软链接：</p> <pre class="prettyprint lang-bsh linenums:1">#CentOS系统
ln -fs /usr/local/lib/security/pam_google_authenticator.so /lib64/security/
#Debian/Ubuntu系统
ln -fs /usr/local/lib/security/pam_google_authenticator.so /lib/x86_64-linux-gnu/security/</pre> <p><strong>3、修改SSH文件</strong><br /> 这里可以直接使用命令：</p> <pre class="prettyprint lang-bsh linenums:1">sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</pre> <p>然后同步下时间：</p> <pre class="prettyprint lang- linenums:1">#查看下服务器时间
date
#如果时区不一样，再使用命令修改为本地时间
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre> <p>对于<code>CentOS</code>系统，还需要关闭<code>SELINUX</code>，不过并不是所有系统都是开启状态，使用命令：</p> <pre class="prettyprint lang-bsh linenums:1">#使用命令查看状态
getenforce
#如果输出disabled则为关闭，反之开启，然后使用命令关闭</pre> <pre class="prettyprint lang-bsh linenums:1">sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</pre> <p>最后重启<code>SSH</code>：</p> <pre class="prettyprint lang-bsh linenums:1">#CentOS系统
service sshd restart
#Debian/Ubuntu系统
service ssh restart</pre> <p>配置好了，再登录<code>SSH</code>的时候，这里以<code>Xshell</code>为例，类型选择<code>Keyboard Interactive</code>方式，然后会要你输入动态验证码了。<br /> <a href="https://zsblog.cn/wp-content/uploads/2019/04/1554739257-1074-Google-Authenticator.png"><img class="attachment-full size-full" src="https://zsblog.cn/wp-content/uploads/2019/04/1554739257-1074-Google-Authenticator.png" alt="Linux VPS安装Google Authenticator实现SSH登陆二次验证" sizes="(max-width: 415px) 100vw, 415px" srcset="https://zsblog.cn/wp-content/uploads/2019/04/1554739257-1074-Google-Authenticator.png 415w, https://zsblog.cn/wp-content/uploads/2019/04/1554739257-1074-Google-Authenticator-300x170.png 300w"></a><br /> 基本上以后我们每次登录<code>VPS</code>的时候，不仅会要你输入密码，还会要你输入谷歌验证的动态码才能进入<code>VPS</code>，安全增加了不少。</p> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- 文章页下方 --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5448507556906408" data-ad-slot="9680245136" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> </div> <div class="content-extras clear-fix"> <!-- 版权信息 --> <p class="single-copyright"> 本文作者为<a href="/406.html" rel="nofollow" target="_blank">zisu</a>，转载请注明。 </p> <!-- 文章标签 --> <p class="single-tags"> <i class="fa fa-tag" aria-hidden="true"></i><a href="/tag/google-authenticator/" rel="tag">Google Authenticator</a> </p> </div> <!-- content-extras --> </div><!-- .entry-content --> <!-- 点赞、分享、打赏组件 --> <div class="social-main"> <div class="like favorite" data-action="ding" data-id="406"> <span class="likeHeart" rel="like"></span> <span class="count">0</span>人点赞 </div> </div> </article><!-- #post --> <div id="article-share"> 分享 <div class="share-item" data-site="weixin" title="分享到微信"> <i class="fa fa-weixin"></i> 微信 </div> <div class="share-item" data-site="weibo" title="分享到新浪微博"> <i class="fa fa-weibo"></i> 微博 </div> <div class="share-item" data-site="qq" title="分享给QQ好友"> <i class="fa fa-qq"></i> QQ </div> </div> <div id="article-menu" data-automenu></div> <footer id="site-footer"> Copyright © zisu & <a href="/" >紫苏博客</a> All Rights Rsesrved. <span>苏ICP备15050462号-1 </span> </footer> <!--[if IE]> <div class="no-ie"> <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> 本博客已不支持 IE <a href="http://lab.mkblog.cn/music/plugns/killie/" target="_blank">点击升级浏览器</a> </div> <![endif]--> <!-- 返回顶部按钮 --> <div id="scroll-to-top" title="返回顶部" class="headroom"> <i class="fa fa-chevron-up" aria-hidden="true"></i> </div> <!-- 初始化小表情、灯箱、代码高亮 --> <script>initTheme();</script> <script data-no-instant> InstantClick.on('change', function(isInitialLoad) { if(isInitialLoad === false) { if(typeof ga!=='undefined') ga('send', 'pageview', location.pathname + location.search); if(typeof MathJax!=='undefined') { MathJax.Hub.Queue(["Typeset",MathJax.Hub]) } if (typeof _hmt !== 'undefined'){ _hmt.push(['_trackPageview', location.pathname + location.search]); } console.log('InitialLoad'); } else { console.log('Normal'); } }); InstantClick.init('mousedown'); </script> </body> </html>
<!--
Performance optimized by W3 Total Cache. Learn more: https://www.w3-edge.com/products/

Object Caching 57/80 objects using memcached
Page Caching using memcached 
Database Caching using memcached

Served from: zsblog.cn @ 2019-04-29 21:37:29 by W3 Total Cache
-->